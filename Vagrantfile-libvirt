Vagrant.configure("2") do |config|
  config.vm.box = "subutai/stretch-nobridge"
  config.vm.hostname = "stretch"
  config.vm.synced_folder '.', '/vagrant', disabled: true

  config.vm.network :forwarded_port, guest: 22, host: 4567
  config.vm.network :forwarded_port, guest: 8443, host: 9999

  config.ssh.username = "subutai"
  config.ssh.password = "ubuntai"

  config.vm.provider :libvirt do |libvirt|
    libvirt.driver = "kvm"
    libvirt.memory = 4096
    libvirt.cpus = 2

    libvirt.connect_via_ssh = false
    libvirt.username = "root"
  end

  config.vm.provision "shell", inline: <<-SHELL

    echo "Finding nearest apt mirror"
    country=`curl -s ipinfo.io | grep country | awk -F ':' '{print $2}' | sed -e 's/[", ]//g'`

    if [ "KG" = "$country" ]; then
      country=KZ
    fi

    netselect-apt -c $country &> /dev/null
    if [ ! "$?" = "0" ]; then
      netselect-apt -c US &> /dev/null
    fi

    if [ -f "sources.list" ]; then
      mv sources.list /etc/apt/sources.list
    fi

    echo "Installing Subutai Snap ..."
    snap install subutai --devmode --beta

    echo "Mounting container storage ..."
    /snap/subutai/current/bin/btrfsinit /dev/mapper/main-btrfs &> /dev/null

    echo "SUCCESS: Debian Stretch resource host (RH) ready!"
    echo 'Want to convert this RH into a peer?'
    echo "Step 1: Use 'vagrant ssh' to get into the RH"
    echo "Step 2: Use 'sudo /snap/bin/subutai import management' to install the peer"
    echo "Step 3: Hit https://localhost:9999 on Chrome with Subutai extension"
    echo "Default user credentials: 'admin' / 'secret'"
    echo "Welcome to the horde!"
  SHELL

end
